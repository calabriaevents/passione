/**
 * SISTEMA UNIFICATO DI TRADUZIONE - PASSIONE CALABRIA
 * 
 * Sistema ibrido che combina:
 * - Traduzioni statiche per elementi comuni (veloce)
 * - Traduzioni API per contenuti dinamici (articoli, etc.)
 * - Gestione intelligente della cache
 * - Rilevamento automatico lingua browser
 * 
 * @author Passione Calabria
 * @version 3.0 - Sistema Unificato
 */

class PassioneUnifiedTranslationSystem {
    constructor(options = {}) {\n        this.options = {\n            apiEndpoint: '/api/translate.php',\n            defaultLanguage: 'it',\n            supportedLanguages: ['it', 'en', 'fr', 'de', 'es'],\n            staticTranslationsEnabled: true,\n            apiTranslationsEnabled: true,\n            cacheEnabled: true,\n            cacheExpiry: 30 * 60 * 1000, // 30 minuti\n            debugMode: false,\n            ...options\n        };\n        \n        this.currentLanguage = this.options.defaultLanguage;\n        this.staticTranslations = this.initStaticTranslations();\n        this.translationCache = new Map();\n        this.isTranslating = false;\n        this.initialized = false;\n        \n        this.init();\n    }\n    \n    /**\n     * Inizializza il sistema\n     */\n    init() {\n        if (this.initialized) {\n            this.log('Sistema gi√† inizializzato, saltando...');\n            return;\n        }\n        \n        this.log('üåê Inizializzando Sistema Unificato di Traduzione...');\n        \n        try {\n            // 1. Rileva lingua corrente\n            this.detectCurrentLanguage();\n            \n            // 2. Carica cache da localStorage\n            this.loadCacheFromStorage();\n            \n            // 3. Setup event listeners\n            this.setupEventListeners();\n            \n            // 4. Applica traduzioni se necessario\n            if (this.currentLanguage !== this.options.defaultLanguage) {\n                this.translatePage();\n            } else {\n                this.updateLanguageUI();\n            }\n            \n            this.initialized = true;\n            this.log('‚úÖ Sistema inizializzato correttamente');\n            \n        } catch (error) {\n            this.log('‚ùå Errore inizializzazione:', error);\n        }\n    }\n    \n    /**\n     * Rileva lingua corrente\n     */\n    detectCurrentLanguage() {\n        // 1. Da parametro URL\n        const urlParams = new URLSearchParams(window.location.search);\n        const urlLang = urlParams.get('lang');\n        if (urlLang && this.options.supportedLanguages.includes(urlLang)) {\n            this.currentLanguage = urlLang;\n            this.saveLanguagePreference(urlLang);\n            this.log(`Lingua da URL: ${urlLang}`);\n            return;\n        }\n        \n        // 2. Da cookie/localStorage\n        const savedLang = localStorage.getItem('passione_language');\n        if (savedLang && this.options.supportedLanguages.includes(savedLang)) {\n            this.currentLanguage = savedLang;\n            this.log(`Lingua salvata: ${savedLang}`);\n            return;\n        }\n        \n        // 3. Usa default\n        this.currentLanguage = this.options.defaultLanguage;\n        this.log(`Lingua default: ${this.currentLanguage}`);\n    }\n    \n    /**\n     * Setup event listeners\n     */\n    setupEventListeners() {\n        // Language buttons\n        document.addEventListener('click', (e) => {\n            const langBtn = e.target.closest('[data-lang]');\n            if (langBtn) {\n                e.preventDefault();\n                const targetLang = langBtn.dataset.lang;\n                if (this.options.supportedLanguages.includes(targetLang)) {\n                    this.changeLanguage(targetLang);\n                }\n            }\n        });\n        \n        // Save cache before unload\n        window.addEventListener('beforeunload', () => {\n            this.saveCacheToStorage();\n        });\n    }\n    \n    /**\n     * Cambia lingua\n     */\n    async changeLanguage(targetLang) {\n        if (!this.options.supportedLanguages.includes(targetLang)) {\n            this.log(`‚ùå Lingua non supportata: ${targetLang}`);\n            return;\n        }\n        \n        if (targetLang === this.currentLanguage) {\n            this.log(`‚ÑπÔ∏è Lingua gi√† attiva: ${targetLang}`);\n            return;\n        }\n        \n        this.log(`üîÑ Cambio lingua a: ${targetLang}`);\n        \n        // Salva preferenza\n        this.currentLanguage = targetLang;\n        this.saveLanguagePreference(targetLang);\n        \n        // Aggiorna URL\n        this.updateURL(targetLang);\n        \n        // Traduci pagina\n        await this.translatePage();\n        \n        // Aggiorna UI\n        this.updateLanguageUI();\n        \n        this.log(`‚úÖ Cambio lingua completato: ${targetLang}`);\n    }\n    \n    /**\n     * Traduci intera pagina\n     */\n    async translatePage() {\n        if (this.isTranslating) {\n            this.log('‚è≥ Traduzione gi√† in corso...');\n            return;\n        }\n        \n        if (this.currentLanguage === this.options.defaultLanguage) {\n            this.resetToOriginal();\n            return;\n        }\n        \n        this.isTranslating = true;\n        \n        try {\n            this.log(`üöÄ Inizio traduzione pagina verso: ${this.currentLanguage}`);\n            \n            // 1. Traduzioni statiche (veloci)\n            if (this.options.staticTranslationsEnabled) {\n                await this.applyStaticTranslations();\n            }\n            \n            // 2. Traduzioni dinamiche via API (pi√π lente)\n            if (this.options.apiTranslationsEnabled) {\n                await this.applyDynamicTranslations();\n            }\n            \n            this.log(`‚úÖ Traduzione completata`);\n            \n        } catch (error) {\n            this.log(`‚ùå Errore durante traduzione:`, error);\n        } finally {\n            this.isTranslating = false;\n        }\n    }\n    \n    /**\n     * Applica traduzioni statiche\n     */\n    async applyStaticTranslations() {\n        const elementsWithDataTranslate = document.querySelectorAll('[data-translate]');\n        \n        elementsWithDataTranslate.forEach(element => {\n            const key = element.getAttribute('data-translate');\n            const translation = this.getStaticTranslation(key);\n            \n            if (translation) {\n                this.applyTranslationToElement(element, translation);\n            }\n        });\n        \n        this.log(`üìù Applicate ${elementsWithDataTranslate.length} traduzioni statiche`);\n    }\n    \n    /**\n     * Applica traduzioni dinamiche\n     */\n    async applyDynamicTranslations() {\n        const dynamicElements = document.querySelectorAll('.translatable:not([data-translate])');\n        \n        if (dynamicElements.length === 0) {\n            this.log('‚ÑπÔ∏è Nessun elemento dinamico da tradurre');\n            return;\n        }\n        \n        this.log(`üîÑ Traducendo ${dynamicElements.length} elementi dinamici...`);\n        \n        // Traduci in batch per performance\n        const batchSize = 5;\n        for (let i = 0; i < dynamicElements.length; i += batchSize) {\n            const batch = Array.from(dynamicElements).slice(i, i + batchSize);\n            const promises = batch.map(element => this.translateDynamicElement(element));\n            await Promise.allSettled(promises);\n            \n            // Piccola pausa per non sovraccaricare l'API\n            if (i + batchSize < dynamicElements.length) {\n                await this.delay(100);\n            }\n        }\n    }\n    \n    /**\n     * Traduci elemento dinamico\n     */\n    async translateDynamicElement(element) {\n        try {\n            const originalText = this.getElementText(element);\n            if (!originalText || originalText.trim().length === 0) {\n                return;\n            }\n            \n            // Controlla cache\n            const cacheKey = this.generateCacheKey(originalText, this.currentLanguage);\n            const cached = this.getFromCache(cacheKey);\n            \n            if (cached) {\n                this.applyTranslationToElement(element, cached.translatedText, originalText);\n                return;\n            }\n            \n            // Richiesta API\n            const translation = await this.requestTranslation(originalText);\n            if (translation && translation.success) {\n                const translatedText = translation.data.translated_text;\n                this.applyTranslationToElement(element, translatedText, originalText);\n                \n                // Salva in cache\n                this.saveToCache(cacheKey, {\n                    translatedText,\n                    timestamp: Date.now()\n                });\n            }\n            \n        } catch (error) {\n            this.log(`‚ùå Errore traduzione elemento:`, error);\n        }\n    }\n    \n    /**\n     * Applica traduzione a elemento\n     */\n    applyTranslationToElement(element, translatedText, originalText = null) {\n        // Salva testo originale se non gi√† salvato\n        if (originalText && !element.dataset.originalText) {\n            element.dataset.originalText = originalText;\n        }\n        \n        // Applica traduzione\n        if (element.tagName === 'INPUT') {\n            if (element.hasAttribute('placeholder')) {\n                element.placeholder = translatedText;\n            } else {\n                element.value = translatedText;\n            }\n        } else {\n            element.textContent = translatedText;\n        }\n        \n        // Marca come tradotto\n        element.classList.add('translated');\n        element.dataset.translatedTo = this.currentLanguage;\n    }\n    \n    /**\n     * Reset alla lingua originale\n     */\n    resetToOriginal() {\n        document.querySelectorAll('[data-original-text]').forEach(element => {\n            const originalText = element.dataset.originalText;\n            if (originalText) {\n                if (element.tagName === 'INPUT') {\n                    if (element.hasAttribute('placeholder')) {\n                        element.placeholder = originalText;\n                    } else {\n                        element.value = originalText;\n                    }\n                } else {\n                    element.textContent = originalText;\n                }\n            }\n            \n            element.classList.remove('translated');\n            delete element.dataset.translatedTo;\n        });\n        \n        this.log('üîÑ Reset alla lingua originale completato');\n    }\n    \n    /**\n     * Richiesta API di traduzione\n     */\n    async requestTranslation(text) {\n        try {\n            const response = await fetch(this.options.apiEndpoint, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                body: JSON.stringify({\n                    text: text,\n                    target_lang: this.currentLanguage,\n                    source_lang: this.options.defaultLanguage\n                })\n            });\n            \n            if (!response.ok) {\n                throw new Error(`HTTP ${response.status}`);\n            }\n            \n            return await response.json();\n            \n        } catch (error) {\n            this.log(`‚ùå Errore API traduzione:`, error);\n            return null;\n        }\n    }\n    \n    /**\n     * Aggiorna URL e link\n     */\n    updateURL(targetLang) {\n        // Aggiorna URL corrente\n        const url = new URL(window.location);\n        if (targetLang === this.options.defaultLanguage) {\n            url.searchParams.delete('lang');\n        } else {\n            url.searchParams.set('lang', targetLang);\n        }\n        window.history.replaceState({}, '', url);\n        \n        // Aggiorna tutti i link interni\n        document.querySelectorAll('a[href]').forEach(link => {\n            const href = link.getAttribute('href');\n            if (href && !href.startsWith('#') && !href.startsWith('http') && \n                !href.startsWith('mailto:') && !href.startsWith('tel:')) {\n                try {\n                    const linkUrl = new URL(href, window.location.origin);\n                    if (targetLang === this.options.defaultLanguage) {\n                        linkUrl.searchParams.delete('lang');\n                    } else {\n                        linkUrl.searchParams.set('lang', targetLang);\n                    }\n                    link.setAttribute('href', linkUrl.pathname + linkUrl.search + linkUrl.hash);\n                } catch (e) {\n                    // URL malformato, ignora\n                }\n            }\n        });\n    }\n    \n    /**\n     * Aggiorna UI lingua\n     */\n    updateLanguageUI() {\n        document.querySelectorAll('[data-lang]').forEach(btn => {\n            const btnLang = btn.dataset.lang;\n            if (btnLang === this.currentLanguage) {\n                btn.classList.add('active');\n                btn.style.opacity = '1';\n            } else {\n                btn.classList.remove('active');\n                btn.style.opacity = '0.7';\n            }\n        });\n        \n        document.body.setAttribute('data-language', this.currentLanguage);\n    }\n    \n    /**\n     * Inizializza traduzioni statiche\n     */\n    initStaticTranslations() {\n        return {\n            it: {\n                // Navigation\n                'nav-home': 'Home',\n                'nav-categories': 'Categorie',\n                'nav-provinces': 'Province',\n                'nav-cities': 'Citt√†',\n                'nav-map': 'Mappa',\n                'nav-collaborate': 'Collabora',\n                \n                // Common elements\n                'explore': 'Esplora',\n                'search': 'Cerca',\n                'loading': 'Caricamento...',\n                'error': 'Errore',\n                'success': 'Successo',\n                'close': 'Chiudi',\n                'save': 'Salva',\n                'cancel': 'Annulla',\n                'back': 'Indietro',\n                'next': 'Avanti',\n                'previous': 'Precedente',\n                \n                // Footer\n                'Esplora': 'Esplora',\n                'Tutte le Categorie': 'Tutte le Categorie',\n                'Le Province': 'Le Province',\n                'Mappa Interattiva': 'Mappa Interattiva',\n                'Tutti gli Articoli': 'Tutti gli Articoli',\n                'Informazioni': 'Informazioni',\n                'Chi Siamo': 'Chi Siamo',\n                'Collabora con Noi': 'Collabora con Noi',\n                'Suggerisci un Luogo': 'Suggerisci un Luogo',\n                'Contatti': 'Contatti',\n                'Privacy Policy': 'Privacy Policy',\n                'Calabria, Italia': 'Calabria, Italia',\n                'La terra tra due mari': 'La terra tra due mari',\n                'Newsletter': 'Newsletter',\n                'Ricevi aggiornamenti sui nuovi contenuti e eventi.': 'Ricevi aggiornamenti sui nuovi contenuti e eventi.',\n                'La tua email': 'La tua email',\n                '¬© 2024 Passione Calabria. Fatto con ‚ô• in Calabria.': '¬© 2024 Passione Calabria. Fatto con ‚ô• in Calabria.',\n                'Termini di Servizio': 'Termini di Servizio',\n                'Privacy': 'Privacy',\n                'La tua guida alla Calabria': 'La tua guida alla Calabria',\n                'Il portale dedicato alla scoperta della Calabria autentica: luoghi, tradizioni, sapori e storie che rendono unica la nostra terra.': 'Il portale dedicato alla scoperta della Calabria autentica: luoghi, tradizioni, sapori e storie che rendono unica la nostra terra.'\n            },\n            en: {\n                // Navigation\n                'nav-home': 'Home',\n                'nav-categories': 'Categories',\n                'nav-provinces': 'Provinces',\n                'nav-cities': 'Cities',\n                'nav-map': 'Map',\n                'nav-collaborate': 'Collaborate',\n                \n                // Common elements\n                'explore': 'Explore',\n                'search': 'Search',\n                'loading': 'Loading...',\n                'error': 'Error',\n                'success': 'Success',\n                'close': 'Close',\n                'save': 'Save',\n                'cancel': 'Cancel',\n                'back': 'Back',\n                'next': 'Next',\n                'previous': 'Previous',\n                \n                // Footer\n                'Esplora': 'Explore',\n                'Tutte le Categorie': 'All Categories',\n                'Le Province': 'The Provinces',\n                'Mappa Interattiva': 'Interactive Map',\n                'Tutti gli Articoli': 'All Articles',\n                'Informazioni': 'Information',\n                'Chi Siamo': 'About Us',\n                'Collabora con Noi': 'Collaborate with Us',\n                'Suggerisci un Luogo': 'Suggest a Place',\n                'Contatti': 'Contacts',\n                'Privacy Policy': 'Privacy Policy',\n                'Calabria, Italia': 'Calabria, Italy',\n                'La terra tra due mari': 'The land between two seas',\n                'Newsletter': 'Newsletter',\n                'Ricevi aggiornamenti sui nuovi contenuti e eventi.': 'Receive updates on new content and events.',\n                'La tua email': 'Your email',\n                '¬© 2024 Passione Calabria. Fatto con ‚ô• in Calabria.': '¬© 2024 Passione Calabria. Made with ‚ô• in Calabria.',\n                'Termini di Servizio': 'Terms of Service',\n                'Privacy': 'Privacy',\n                'La tua guida alla Calabria': 'Your guide to Calabria',\n                'Il portale dedicato alla scoperta della Calabria autentica: luoghi, tradizioni, sapori e storie che rendono unica la nostra terra.': 'The portal dedicated to discovering authentic Calabria: places, traditions, flavors and stories that make our land unique.'\n            },\n            fr: {\n                // Navigation\n                'nav-home': 'Accueil',\n                'nav-categories': 'Cat√©gories',\n                'nav-provinces': 'Provinces',\n                'nav-cities': 'Villes',\n                'nav-map': 'Carte',\n                'nav-collaborate': 'Collaborer',\n                \n                // Common elements\n                'explore': 'Explorer',\n                'search': 'Rechercher',\n                'loading': 'Chargement...',\n                'error': 'Erreur',\n                'success': 'Succ√®s',\n                'close': 'Fermer',\n                'save': 'Sauvegarder',\n                'cancel': 'Annuler',\n                'back': 'Retour',\n                'next': 'Suivant',\n                'previous': 'Pr√©c√©dent',\n                \n                // Footer\n                'Esplora': 'Explorer',\n                'Tutte le Categorie': 'Toutes les Cat√©gories',\n                'Le Province': 'Les Provinces',\n                'Mappa Interattiva': 'Carte Interactive',\n                'Tutti gli Articoli': 'Tous les Articles',\n                'Informazioni': 'Informations',\n                'Chi Siamo': 'Qui Nous Sommes',\n                'Collabora con Noi': 'Collaborez avec Nous',\n                'Suggerisci un Luogo': 'Sugg√©rer un Lieu',\n                'Contatti': 'Contacts',\n                'Privacy Policy': 'Politique de Confidentialit√©',\n                'Calabria, Italia': 'Calabre, Italie',\n                'La terra tra due mari': 'La terre entre deux mers',\n                'Newsletter': 'Newsletter',\n                'Ricevi aggiornamenti sui nuovi contenuti e eventi.': 'Recevez des mises √† jour sur le nouveau contenu et les √©v√©nements.',\n                'La tua email': 'Votre email',\n                '¬© 2024 Passione Calabria. Fatto con ‚ô• in Calabria.': '¬© 2024 Passione Calabria. Fait avec ‚ô• en Calabre.',\n                'Termini di Servizio': 'Conditions de Service',\n                'Privacy': 'Confidentialit√©',\n                'La tua guida alla Calabria': 'Votre guide de la Calabre',\n                'Il portale dedicato alla scoperta della Calabria autentica: luoghi, tradizioni, sapori e storie che rendono unica la nostra terra.': 'Le portail d√©di√© √† la d√©couverte de la Calabre authentique : lieux, traditions, saveurs et histoires qui rendent notre terre unique.'\n            },\n            de: {\n                // Navigation\n                'nav-home': 'Startseite',\n                'nav-categories': 'Kategorien',\n                'nav-provinces': 'Provinzen',\n                'nav-cities': 'St√§dte',\n                'nav-map': 'Karte',\n                'nav-collaborate': 'Zusammenarbeiten',\n                \n                // Common elements\n                'explore': 'Erkunden',\n                'search': 'Suchen',\n                'loading': 'Laden...',\n                'error': 'Fehler',\n                'success': 'Erfolg',\n                'close': 'Schlie√üen',\n                'save': 'Speichern',\n                'cancel': 'Abbrechen',\n                'back': 'Zur√ºck',\n                'next': 'Weiter',\n                'previous': 'Vorherige',\n                \n                // Footer\n                'Esplora': 'Erkunden',\n                'Tutte le Categorie': 'Alle Kategorien',\n                'Le Province': 'Die Provinzen',\n                'Mappa Interattiva': 'Interaktive Karte',\n                'Tutti gli Articoli': 'Alle Artikel',\n                'Informazioni': 'Informationen',\n                'Chi Siamo': '√úber Uns',\n                'Collabora con Noi': 'Mit Uns Zusammenarbeiten',\n                'Suggerisci un Luogo': 'Einen Ort Vorschlagen',\n                'Contatti': 'Kontakte',\n                'Privacy Policy': 'Datenschutzrichtlinie',\n                'Calabria, Italia': 'Kalabrien, Italien',\n                'La terra tra due mari': 'Das Land zwischen zwei Meeren',\n                'Newsletter': 'Newsletter',\n                'Ricevi aggiornamenti sui nuovi contenuti e eventi.': 'Erhalten Sie Updates zu neuen Inhalten und Veranstaltungen.',\n                'La tua email': 'Ihre E-Mail',\n                '¬© 2024 Passione Calabria. Fatto con ‚ô• in Calabria.': '¬© 2024 Passione Calabria. Mit ‚ô• in Kalabrien gemacht.',\n                'Termini di Servizio': 'Nutzungsbedingungen',\n                'Privacy': 'Datenschutz',\n                'La tua guida alla Calabria': 'Ihr Kalabrien-F√ºhrer',\n                'Il portale dedicato alla scoperta della Calabria autentica: luoghi, tradizioni, sapori e storie che rendono unica la nostra terra.': 'Das Portal f√ºr die Entdeckung des authentischen Kalabriens: Orte, Traditionen, Geschm√§cker und Geschichten, die unser Land einzigartig machen.'\n            },\n            es: {\n                // Navigation\n                'nav-home': 'Inicio',\n                'nav-categories': 'Categor√≠as',\n                'nav-provinces': 'Provincias',\n                'nav-cities': 'Ciudades',\n                'nav-map': 'Mapa',\n                'nav-collaborate': 'Colaborar',\n                \n                // Common elements\n                'explore': 'Explorar',\n                'search': 'Buscar',\n                'loading': 'Cargando...',\n                'error': 'Error',\n                'success': '√âxito',\n                'close': 'Cerrar',\n                'save': 'Guardar',\n                'cancel': 'Cancelar',\n                'back': 'Atr√°s',\n                'next': 'Siguiente',\n                'previous': 'Anterior',\n                \n                // Footer\n                'Esplora': 'Explorar',\n                'Tutte le Categorie': 'Todas las Categor√≠as',\n                'Le Province': 'Las Provincias',\n                'Mappa Interattiva': 'Mapa Interactivo',\n                'Tutti gli Articoli': 'Todos los Art√≠culos',\n                'Informazioni': 'Informaci√≥n',\n                'Chi Siamo': 'Qui√©nes Somos',\n                'Collabora con Noi': 'Colabora con Nosotros',\n                'Suggerisci un Luogo': 'Sugerir un Lugar',\n                'Contatti': 'Contactos',\n                'Privacy Policy': 'Pol√≠tica de Privacidad',\n                'Calabria, Italia': 'Calabria, Italia',\n                'La terra tra due mari': 'La tierra entre dos mares',\n                'Newsletter': 'Newsletter',\n                'Ricevi aggiornamenti sui nuovi contenuti e eventi.': 'Recibe actualizaciones sobre nuevo contenido y eventos.',\n                'La tua email': 'Tu email',\n                '¬© 2024 Passione Calabria. Fatto con ‚ô• in Calabria.': '¬© 2024 Passione Calabria. Hecho con ‚ô• en Calabria.',\n                'Termini di Servizio': 'T√©rminos de Servicio',\n                'Privacy': 'Privacidad',\n                'La tua guida alla Calabria': 'Tu gu√≠a de Calabria',\n                'Il portale dedicato alla scoperta della Calabria autentica: luoghi, tradizioni, sapori e storie che rendono unica la nostra terra.': 'El portal dedicado al descubrimiento de la Calabria aut√©ntica: lugares, tradiciones, sabores e historias que hacen √∫nica nuestra tierra.'\n            }\n        };\n    }\n    \n    /**\n     * Ottieni traduzione statica\n     */\n    getStaticTranslation(key) {\n        return this.staticTranslations[this.currentLanguage]?.[key] || null;\n    }\n    \n    /**\n     * Gestione cache\n     */\n    generateCacheKey(text, targetLang) {\n        const normalizedText = text.trim().replace(/\\s+/g, ' ');\n        return `${targetLang}:${btoa(normalizedText).substring(0, 32)}`;\n    }\n    \n    getFromCache(key) {\n        if (!this.options.cacheEnabled) return null;\n        \n        const cached = this.translationCache.get(key);\n        if (!cached) return null;\n        \n        if (Date.now() - cached.timestamp > this.options.cacheExpiry) {\n            this.translationCache.delete(key);\n            return null;\n        }\n        \n        return cached;\n    }\n    \n    saveToCache(key, data) {\n        if (!this.options.cacheEnabled) return;\n        \n        this.translationCache.set(key, {\n            ...data,\n            timestamp: Date.now()\n        });\n    }\n    \n    loadCacheFromStorage() {\n        if (!this.options.cacheEnabled) return;\n        \n        try {\n            const stored = localStorage.getItem('passione_translation_cache');\n            if (stored) {\n                const data = JSON.parse(stored);\n                this.translationCache = new Map(data);\n                this.log(`üíæ Cache caricata: ${this.translationCache.size} elementi`);\n            }\n        } catch (error) {\n            this.log('‚ö†Ô∏è Errore caricamento cache:', error);\n        }\n    }\n    \n    saveCacheToStorage() {\n        if (!this.options.cacheEnabled) return;\n        \n        try {\n            const data = Array.from(this.translationCache.entries());\n            localStorage.setItem('passione_translation_cache', JSON.stringify(data));\n        } catch (error) {\n            this.log('‚ö†Ô∏è Errore salvataggio cache:', error);\n        }\n    }\n    \n    /**\n     * Utility functions\n     */\n    getElementText(element) {\n        if (element.dataset.originalText) {\n            return element.dataset.originalText;\n        }\n        \n        return element.textContent?.trim() || '';\n    }\n    \n    saveLanguagePreference(language) {\n        localStorage.setItem('passione_language', language);\n    }\n    \n    delay(ms) {\n        return new Promise(resolve => setTimeout(resolve, ms));\n    }\n    \n    log(...args) {\n        if (this.options.debugMode) {\n            console.log('[UnifiedTranslation]', ...args);\n        }\n    }\n    \n    /**\n     * API pubblica\n     */\n    getCurrentLanguage() {\n        return this.currentLanguage;\n    }\n    \n    getSupportedLanguages() {\n        return [...this.options.supportedLanguages];\n    }\n    \n    forceRetranslate() {\n        document.querySelectorAll('.translated').forEach(el => {\n            el.classList.remove('translated');\n            delete el.dataset.translatedTo;\n        });\n        \n        return this.translatePage();\n    }\n}\n\n// Auto-initialize quando DOM √® pronto\nif (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', function() {\n        if (!window.PassioneTranslation) {\n            window.PassioneTranslation = new PassioneUnifiedTranslationSystem({\n                debugMode: window.location.search.includes('translation_debug=true')\n            });\n            \n            // Esponi funzioni globali\n            window.changeLanguage = (lang) => window.PassioneTranslation?.changeLanguage(lang);\n            window.forceRetranslate = () => window.PassioneTranslation?.forceRetranslate();\n        }\n    });\n} else {\n    if (!window.PassioneTranslation) {\n        window.PassioneTranslation = new PassioneUnifiedTranslationSystem({\n            debugMode: window.location.search.includes('translation_debug=true')\n        });\n        \n        // Esponi funzioni globali\n        window.changeLanguage = (lang) => window.PassioneTranslation?.changeLanguage(lang);\n        window.forceRetranslate = () => window.PassioneTranslation?.forceRetranslate();\n    }\n}\n\n// Esporta per uso come modulo\nif (typeof module !== 'undefined' && module.exports) {\n    module.exports = PassioneUnifiedTranslationSystem;\n}"